# GitHub Actions Workflow for generating new leads and saving them to a local CSV.
name: 1 - Generate Leads to CSV

on:
  workflow_dispatch:
    inputs:
      location:
        description: 'Target Location (e.g., "San Francisco")'
        required: true
        default: 'Surabaya, Indonesia'
      sector:
        # --- REVISION: Sector is now optional ---
        description: 'Optional: Target Sector (e.g., "Technology"). Leave empty to search all sectors.'
        required: false
        default: ''
      num_companies:
        description: 'Number of new companies to generate'
        required: true
        default: '15'
      workers:
        description: 'Number of parallel workers'
        required: true
        default: '2'

jobs:
  generate-leads:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 2. Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: 3. Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 4. Create .env file from GitHub Secrets
        run: |
          echo "GEMINI_API_KEYS=${{ secrets.GEMINI_API_KEYS }}" >> .env

      - name: 5. Run the Lead Generation Script
        id: generate
        run: |
          # --- REVISION: Conditionally build the command ---
          # Start with the base command, including required arguments.
          CMD="python leads_generator.py \
            --location \"${{ github.event.inputs.location }}\" \
            --num_companies ${{ github.event.inputs.num_companies }} \
            --workers ${{ github.event.inputs.workers }}"
          
          # If the sector input is not empty, add the --sector argument to the command.
          if [[ -n "${{ github.event.inputs.sector }}" ]]; then
            CMD="$CMD --sector \"${{ github.event.inputs.sector }}\""
          fi
          
          # Print the final command for debugging purposes and then execute it.
          echo "Executing: $CMD"
          eval $CMD

      - name: 6. Configure Git for Commit
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions-bot@github.com"

      - name: 7. Commit and Push Updated CSV
        run: |
          git add lead_results/lead_results.csv
          
          if git diff-index --quiet HEAD --; then
            echo "No new leads were added to the CSV. Working tree clean."
          else
            echo "New leads detected in CSV. Committing and pushing..."
            git commit -m "feat(data): Update lead results database via GitHub Actions"
            git push
          fi
